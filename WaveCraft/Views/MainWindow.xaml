<Window x:Class="WaveCraft.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:controls="clr-namespace:WaveCraft.Views.Controls"
        xmlns:converters="clr-namespace:WaveCraft.Converters"
        Title="{Binding Title}"
        Width="1600" Height="900"
        MinWidth="1200" MinHeight="700"
        Background="{StaticResource AbletonBackground}"
        WindowStartupLocation="CenterScreen">

    <Window.InputBindings>
        <KeyBinding Key="Space" Command="{Binding Transport.PlayCommand}"/>
        <KeyBinding Key="S" Modifiers="Ctrl" Command="{Binding SaveProjectCommand}"/>
        <KeyBinding Key="O" Modifiers="Ctrl" Command="{Binding OpenProjectCommand}"/>
        <KeyBinding Key="N" Modifiers="Ctrl" Command="{Binding NewProjectCommand}"/>
        <KeyBinding Key="E" Modifiers="Ctrl" Command="{Binding ExportWavCommand}"/>
        <KeyBinding Key="P" Modifiers="Ctrl" Command="{Binding OpenPianoRollCommand}"/>
        <KeyBinding Key="B" Modifiers="Ctrl" Command="{Binding OpenVstBrowserCommand}"/>
    </Window.InputBindings>

    <Window.Resources>
        <!-- Clip Template for Audio clips -->
        <DataTemplate x:Key="AudioClipTemplate">
            <Border Background="{StaticResource AbletonPanel}" 
                    BorderBrush="{StaticResource AbletonOrange}"
                    BorderThickness="1"
                    CornerRadius="2"
                    Margin="2"
                    Height="70"
                    MinWidth="40">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="16"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <TextBlock Grid.Row="0" 
                               Text="{Binding Name}"
                               Foreground="{StaticResource AbletonTextPrimary}"
                               FontSize="9"
                               Margin="4,2"
                               TextTrimming="CharacterEllipsis"/>

                    <controls:WaveformControl Grid.Row="1"
                                              Waveform="{Binding WaveformData}"
                                              WaveColor="#FF89B4FA"
                                              RmsColor="#FF45475A"
                                              BackgroundColor="#FF1E1E1E"
                                              Margin="2"/>
                </Grid>
            </Border>
        </DataTemplate>

        <!-- MIDI Clip Template -->
        <DataTemplate x:Key="MidiClipTemplate">
            <Border Background="{StaticResource AbletonPanel}" 
                    BorderBrush="#FF89B4FA"
                    BorderThickness="1"
                    CornerRadius="2"
                    Margin="2"
                    Height="70"
                    MinWidth="40">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="16"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <TextBlock Grid.Row="0" 
                               Text="{Binding Name}"
                               Foreground="{StaticResource AbletonTextPrimary}"
                               FontSize="9"
                               Margin="4,2"
                               TextTrimming="CharacterEllipsis"/>

                    <controls:MidiClipControl Grid.Row="1"
                                              MidiClip="{Binding Model}"
                                              NoteColor="#FF89B4FA"
                                              BackgroundColor="#FF1E1E1E"
                                              Margin="2"/>
                </Grid>
            </Border>
        </DataTemplate>

        <!-- Clip Template Selector -->
        <converters:ClipTemplateSelector x:Key="ClipTemplateSelector"
                                         AudioClipTemplate="{StaticResource AudioClipTemplate}"
                                         MidiClipTemplate="{StaticResource MidiClipTemplate}"/>

        <!-- Track Header Template -->
        <DataTemplate x:Key="TrackHeaderTemplate">
            <Border Background="{StaticResource AbletonPanel}" 
                    BorderBrush="{StaticResource AbletonBorder}" 
                    BorderThickness="0,0,0,1"
                    Height="80">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <Grid Grid.Column="0" Margin="6,4">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <!-- Track name -->
                        <TextBox Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="2"
                                 Text="{Binding Name, UpdateSourceTrigger=LostFocus}"
                                 FontSize="11" FontWeight="SemiBold"
                                 Background="Transparent" BorderThickness="0"
                                 Foreground="{StaticResource AbletonTextHighlight}"
                                 Margin="0,0,0,2"/>

                        <!-- Instrument name (MIDI tracks only) -->
                        <TextBlock Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                                   Text="{Binding InstrumentName}"
                                   FontSize="9"
                                   Foreground="{StaticResource AbletonTextSecondary}"
                                   Margin="0,0,0,4"
                                   Visibility="{Binding IsMidiTrack, Converter={StaticResource BoolToVis}}">
                            <TextBlock.InputBindings>
                                <MouseBinding MouseAction="LeftClick" 
                                              Command="{Binding SelectInstrumentCommand}"/>
                            </TextBlock.InputBindings>
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Cursor" Value="Hand"/>
                                    <Style.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Foreground" Value="{StaticResource AbletonOrange}"/>
                                            <Setter Property="TextDecorations" Value="Underline"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>

                        <!-- Volume slider and label -->
                        <Grid Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            
                            <Grid Grid.Row="0" Margin="0,0,0,2">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                
                                <TextBlock Grid.Column="0" Text="Vol" 
                                           Foreground="{StaticResource AbletonTextSecondary}"
                                           FontSize="9" VerticalAlignment="Center" Margin="0,0,4,0"/>
                                <Slider Grid.Column="1" 
                                        Minimum="0" Maximum="2" 
                                        Value="{Binding Volume}"
                                        Height="16" VerticalAlignment="Center"/>
                            </Grid>
                            
                            <TextBlock Grid.Row="1" 
                                       Text="{Binding VolumeDb}" 
                                       Foreground="{StaticResource AbletonTextSecondary}"
                                       FontSize="9" HorizontalAlignment="Right"/>
                        </Grid>

                        <!-- Buttons row -->
                        <StackPanel Grid.Row="3" Grid.Column="0" Grid.ColumnSpan="2" 
                                    Orientation="Horizontal" Margin="0,4,0,0">
                            <ToggleButton Content="M" 
                                          IsChecked="{Binding IsMuted}"
                                          Width="24" Height="20" Padding="0"
                                          FontSize="9" FontWeight="Bold"
                                          Margin="0,0,2,0">
                                <ToggleButton.Style>
                                    <Style TargetType="ToggleButton" BasedOn="{StaticResource {x:Type ToggleButton}}">
                                        <Style.Triggers>
                                            <Trigger Property="IsChecked" Value="True">
                                                <Setter Property="Background" Value="{StaticResource AbletonOrange}"/>
                                                <Setter Property="Foreground" Value="White"/>
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </ToggleButton.Style>
                            </ToggleButton>
                            
                            <ToggleButton Content="S" 
                                          IsChecked="{Binding IsSoloed}"
                                          Width="24" Height="20" Padding="0"
                                          FontSize="9" FontWeight="Bold"
                                          Margin="0,0,4,0">
                                <ToggleButton.Style>
                                    <Style TargetType="ToggleButton" BasedOn="{StaticResource {x:Type ToggleButton}}">
                                        <Style.Triggers>
                                            <Trigger Property="IsChecked" Value="True">
                                                <Setter Property="Background" Value="{StaticResource AbletonBlue}"/>
                                                <Setter Property="Foreground" Value="White"/>
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </ToggleButton.Style>
                            </ToggleButton>

                            <TextBlock Text="{Binding PanLabel}" 
                                       Foreground="{StaticResource AbletonTextSecondary}"
                                       FontSize="9" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Grid>
                </Grid>
            </Border>
        </DataTemplate>
    </Window.Resources>

    <DockPanel>
        <!-- ========== TITLE BAR & MENU ========== -->
        <Menu DockPanel.Dock="Top" Background="{StaticResource AbletonPanel}">
            <MenuItem Header="_File">
                <MenuItem Header="_New Project" 
                          Command="{Binding NewProjectCommand}"
                          InputGestureText="Ctrl+N"/>
                <MenuItem Header="_Open Project..." 
                          Command="{Binding OpenProjectCommand}"
                          InputGestureText="Ctrl+O"/>
                <Separator/>
                <MenuItem Header="_Save Project" 
                          Command="{Binding SaveProjectCommand}"
                          InputGestureText="Ctrl+S"/>
                <MenuItem Header="Save Project _As..." 
                          Command="{Binding SaveProjectAsCommand}"/>
                <Separator/>
                <MenuItem Header="_Export Audio..." 
                          Command="{Binding ExportWavCommand}"
                          InputGestureText="Ctrl+E"/>
                <Separator/>
                <MenuItem Header="E_xit" 
                          Command="{Binding ExitCommand}"/>
            </MenuItem>

            <MenuItem Header="_Edit">
                <MenuItem Header="Undo" InputGestureText="Ctrl+Z"/>
                <MenuItem Header="Redo" InputGestureText="Ctrl+Y"/>
            </MenuItem>

            <MenuItem Header="_Create">
                <MenuItem Header="Add _Audio Track" 
                          Command="{Binding Mixer.AddTrackCommand}"/>
                <MenuItem Header="Add _MIDI Track" 
                          Command="{Binding AddMidiTrackCommand}"/>
            </MenuItem>

            <MenuItem Header="_View">
                <MenuItem Header="Piano Roll" 
                          Command="{Binding OpenPianoRollCommand}"
                          InputGestureText="Ctrl+P"/>
            </MenuItem>

            <MenuItem Header="_Options">
                <MenuItem Header="VST Browser" 
                          Command="{Binding OpenVstBrowserCommand}"
                          InputGestureText="Ctrl+B"/>
                <MenuItem Header="Import MIDI..." 
                          Command="{Binding ImportMidiCommand}"/>
                <MenuItem Header="Export MIDI..." 
                          Command="{Binding ExportMidiCommand}"/>
            </MenuItem>
        </Menu>

        <!-- ========== TRANSPORT BAR ========== -->
        <Border DockPanel.Dock="Top" 
                Background="{StaticResource AbletonPanel}" 
                BorderBrush="{StaticResource AbletonBorder}"
                BorderThickness="0,1,0,1"
                Height="48">
            <Grid Margin="8,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Left: Transport Controls -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                    <Button Command="{Binding Transport.PlayCommand}"
                            Width="48" Height="32" Margin="0,0,4,0"
                            Background="{StaticResource AbletonPanel}">
                        <TextBlock Text="▶" FontSize="16" 
                                   Foreground="{StaticResource AbletonTextHighlight}"/>
                    </Button>
                    
                    <Button Command="{Binding Transport.StopCommand}"
                            Width="48" Height="32"
                            Background="{StaticResource AbletonPanel}">
                        <TextBlock Text="■" FontSize="16" 
                                   Foreground="{StaticResource AbletonTextHighlight}"/>
                    </Button>
                </StackPanel>

                <!-- Center: Position Display -->
                <StackPanel Grid.Column="1" 
                            Orientation="Vertical" 
                            HorizontalAlignment="Center" 
                            VerticalAlignment="Center">
                    <TextBlock Text="{Binding Transport.BarBeatText}"
                               FontFamily="Consolas"
                               FontSize="20"
                               FontWeight="Bold"
                               Foreground="{StaticResource AbletonTextHighlight}"
                               HorizontalAlignment="Center"/>
                    <TextBlock Text="{Binding Transport.PositionText}"
                               FontFamily="Consolas"
                               FontSize="10"
                               Foreground="{StaticResource AbletonTextSecondary}"
                               HorizontalAlignment="Center"
                               Margin="0,2,0,0"/>
                </StackPanel>

                <!-- Right: BPM, Meters, Master Volume -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                    <!-- BPM -->
                    <StackPanel Orientation="Horizontal" Margin="0,0,12,0">
                        <TextBlock Text="BPM" 
                                   Foreground="{StaticResource AbletonTextSecondary}"
                                   FontSize="10" VerticalAlignment="Center" Margin="0,0,4,0"/>
                        <TextBox Text="{Binding Transport.Bpm, UpdateSourceTrigger=LostFocus}"
                                 Width="50" Height="24"
                                 FontFamily="Consolas" FontSize="11"
                                 VerticalContentAlignment="Center"
                                 TextAlignment="Center"/>
                    </StackPanel>

                    <!-- Peak Meters -->
                    <StackPanel Orientation="Horizontal" Margin="0,0,12,0">
                        <controls:PeakMeterControl Width="12" Height="32"
                                                   PeakLevel="{Binding Transport.LeftPeak}"
                                                   RmsLevel="0"
                                                   Margin="0,0,2,0"/>
                        <controls:PeakMeterControl Width="12" Height="32"
                                                   PeakLevel="{Binding Transport.RightPeak}"
                                                   RmsLevel="0"/>
                    </StackPanel>

                    <!-- Master Volume -->
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="Master" 
                                   Foreground="{StaticResource AbletonTextSecondary}"
                                   FontSize="10" VerticalAlignment="Center" Margin="0,0,4,0"/>
                        <Slider Minimum="0" Maximum="2" 
                                Value="{Binding Mixer.MasterVolume}"
                                Width="80" Height="20" VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding Mixer.MasterVolumeDb}" 
                                   Foreground="{StaticResource AbletonTextSecondary}"
                                   FontSize="9" VerticalAlignment="Center" 
                                   Width="45" Margin="4,0,0,0"/>
                    </StackPanel>
                </StackPanel>
            </Grid>
        </Border>

        <!-- ========== STATUS BAR ========== -->
        <Border DockPanel.Dock="Bottom" 
                Background="{StaticResource AbletonPanel}"
                BorderBrush="{StaticResource AbletonBorder}"
                BorderThickness="0,1,0,0"
                Height="24">
            <Grid Margin="8,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0"
                           Text="{Binding StatusText}"
                           Foreground="{StaticResource AbletonTextPrimary}"
                           FontSize="10"
                           VerticalAlignment="Center"/>

                <TextBlock Grid.Column="1"
                           Foreground="{StaticResource AbletonTextSecondary}"
                           FontSize="9"
                           VerticalAlignment="Center">
                    <Run Text="Tracks:"/>
                    <Run Text="{Binding Mixer.AllTracks.Count, Mode=OneWay}"/>
                    <Run Text="  |  Sample Rate: 44100 Hz"/>
                </TextBlock>
            </Grid>
        </Border>

        <!-- ========== MAIN CONTENT AREA ========== -->
        <Grid DockPanel.Dock="Top">
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="0" MinHeight="0"/>
            </Grid.RowDefinitions>

            <!-- ========== ARRANGEMENT VIEW ========== -->
            <Grid Grid.Row="0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="200"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- ===== LEFT: TRACK HEADERS ===== -->
                <Border Grid.Column="0" 
                        Background="{StaticResource AbletonPanel}"
                        BorderBrush="{StaticResource AbletonBorder}"
                        BorderThickness="0,0,1,0">
                    <ScrollViewer VerticalScrollBarVisibility="Hidden"
                                  HorizontalScrollBarVisibility="Disabled"
                                  x:Name="TrackHeaderScrollViewer">
                        <ItemsControl ItemsSource="{Binding Mixer.AllTracks}"
                                      AlternationCount="999">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <ContentControl Content="{Binding}" 
                                                    ContentTemplate="{StaticResource TrackHeaderTemplate}"/>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Border>

                <!-- ===== RIGHT: ARRANGEMENT TIMELINE ===== -->
                <Grid Grid.Column="1" Background="{StaticResource AbletonBackground}">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="32"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Timeline Ruler -->
                    <Border Grid.Row="0" 
                            Background="{StaticResource AbletonPanel}"
                            BorderBrush="{StaticResource AbletonBorder}"
                            BorderThickness="0,0,0,1">
                        <controls:PlayheadTimelineControl 
                            Height="32"
                            PlayheadPosition="{Binding Transport.PlayheadPosition}"
                            Bpm="{Binding Transport.Bpm}"/>
                    </Border>

                    <!-- Tracks and Clips Area -->
                    <ScrollViewer Grid.Row="1"
                                  HorizontalScrollBarVisibility="Auto"
                                  VerticalScrollBarVisibility="Auto"
                                  x:Name="ArrangementScrollViewer">
                        <Grid>
                            <!-- Background grid lines would go here -->
                            
                            <!-- Track lanes -->
                            <ItemsControl ItemsSource="{Binding Mixer.AllTracks}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Height="80" 
                                                BorderBrush="{StaticResource AbletonGridMinor}"
                                                BorderThickness="0,0,0,1">
                                            <!-- Clips for this track -->
                                            <ItemsControl ItemsSource="{Binding Clips}">
                                                <ItemsControl.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <WrapPanel Orientation="Horizontal"/>
                                                    </ItemsPanelTemplate>
                                                </ItemsControl.ItemsPanel>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <ContentControl Content="{Binding}" 
                                                                        ContentTemplateSelector="{StaticResource ClipTemplateSelector}"/>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>

                            <!-- Playhead overlay -->
                            <controls:PlayheadLineOverlay 
                                PlayheadPosition="{Binding Transport.PlayheadPosition}"
                                IsHitTestVisible="False"/>
                        </Grid>
                    </ScrollViewer>
                </Grid>
            </Grid>

            <!-- ========== DETAIL PANEL (COLLAPSED BY DEFAULT) ========== -->
            <GridSplitter Grid.Row="1" 
                          Height="5"
                          HorizontalAlignment="Stretch"
                          Background="{StaticResource AbletonBorder}"
                          Visibility="Collapsed"/>

            <Border Grid.Row="2" 
                    Background="{StaticResource AbletonPanel}"
                    Visibility="Collapsed">
                <TabControl Background="{StaticResource AbletonPanel}">
                    <TabItem Header="Clip">
                        <TextBlock Text="Clip details" 
                                   Foreground="{StaticResource AbletonTextSecondary}"
                                   Margin="8"/>
                    </TabItem>
                    <TabItem Header="Device">
                        <TextBlock Text="Device chain" 
                                   Foreground="{StaticResource AbletonTextSecondary}"
                                   Margin="8"/>
                    </TabItem>
                    <TabItem Header="Browser">
                        <TextBlock Text="Browser" 
                                   Foreground="{StaticResource AbletonTextSecondary}"
                                   Margin="8"/>
                    </TabItem>
                </TabControl>
            </Border>
        </Grid>
    </DockPanel>
</Window>
